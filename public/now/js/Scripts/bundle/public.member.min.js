;(function(){function a(a,b){function d(c){var d=b.defer();return a({method:"POST",url:"/Member/GetListProvince"}).success(d.resolve).error(d.reject),d.promise}function e(c){var d=b.defer();return a({method:"POST",url:"/Member/GetListDistrictByProvince",data:{provinceId:c}}).success(d.resolve).error(d.reject),d.promise}function f(c){var d=b.defer();return a({method:"POST",url:"/Member/UpdateAddressInfo",data:{item:c}}).success(d.resolve).error(d.reject),d.promise}function g(c){var d=b.defer();return a({method:"POST",url:"/Member/DeleteAddressInfo",data:{id:c}}).success(d.resolve).error(d.reject),d.promise}function h(c,d,e,f){var g=b.defer();return a({method:"POST",url:"/Member/GetListTrans",data:{pageIndex:c,pageSize:d,balanceType:e,transType:f}}).success(g.resolve).error(g.reject),g.promise}function i(c){var d=b.defer();return a({method:"POST",url:"/Member/TransferToBalance",data:{changedBalance:c}}).success(d.resolve).error(d.reject),d.promise}function j(c,d,e,f,g){var h=b.defer();return a({method:"POST",url:"/Member/Topup",data:{amount:c,paymentMethod:d,returnUrl:e,card:f,password:g}}).success(h.resolve).error(h.reject),h.promise}function k(c,d,e){var f=b.defer();return a({method:"POST",url:"/Member/GetWorkingUserInfo"}).success(f.resolve).error(f.reject),f.promise}function l(){var c=b.defer();return a({method:"POST",url:"/Member/GetListAddressInfo"}).success(c.resolve).error(c.reject),c.promise}function m(){var c=b.defer();return a({method:"POST",url:"/Member/UserBalance"}).success(c.resolve).error(c.reject),c.promise}function n(){var c=b.defer();return a({method:"POST",url:"/Member/CashBack"}).success(c.resolve).error(c.reject),c.promise}function o(){var c=b.defer();return a({method:"POST",url:"/Member/GetUserPaymentSetting"}).success(c.resolve).error(c.reject),c.promise}function p(c){var d=b.defer();return a({method:"POST",url:"/Member/UpdateUserPaymentSetting",data:JSON.stringify(c)}).success(d.resolve).error(d.reject),d.promise}function q(c){var d=b.defer();return a({method:"POST",url:"/Member/Topup",data:JSON.stringify(c)}).success(d.resolve).error(d.reject),d.promise}function r(){var c=b.defer();return a({method:"POST",url:"/Common/GetCurrentTime"}).success(c.resolve).error(c.reject),c.promise}var c={getListProvince:d,getDistrictByProvinceId:e,updateAddressInfo:f,deleteAddressInfo:g,getListUserTrans:h,redeemCashBack:i,sendRequest:j,getWorkingUser:k,getListAddressInfo:l,getUserBalance:m,getCashBackUserBalance:n,getUserPaymentSetting:o,updateUserPaymentSetting:p,userTopup:q,getCurrentTime:r};return c}"use strict",angular.module("deliveryNow").factory("commonService",a),a.$inject=["$http","$q"]})()
;(function(){function a(a,b,c,d){function f(){var a=urlParam("success");if(a!=null){var c="";a==="true"?c=Message.DeN_Web_AirpayCredit_Add_Card_Success:c=Message.DeN_Web_AirpayCredit_Add_Card_Fail,deliveryAlert(c);var d=removeParam("success",location.href);window.history.pushState("",document.title,d)}o(),b.getListProvince().then(function(a){a.success&&(e.location=a.data,e.locationSelected=e.location[a.index],g(""))}),p()}function g(a){if(e.locationSelected){var c=e.locationSelected.Id;c&&b.getDistrictByProvinceId(c).then(function(b){b.success&&(e.district=b.data,a==""?e.districtSelected=e.district[0]:h(a))})}}function h(a){for(var b=0;b<e.district.length;b++){var c=e.district[b];if(c.Id==a){e.districtSelected=e.district[b];break}}}function i(a){for(var b=0;b<e.location.length;b++){var c=e.location[b];if(c.Id==a){e.locationSelected=e.location[b];break}}}function j(){e.userData?(e.userData=angular.copy(e.userData),e.userData.Id=0,e.userData.Label="",e.userData.FullAddress="",e.userData.FullName="",e.userData.Status=1,e.userData.CreatedOn=new Date,e.userData.UpdatedOn=new Date):e.userData={Id:0,Label:"",FullName:"",FullAddress:"",Status:1,CreatedOn:new Date,UpdatedOn:new Date},$("#edit-address").openModal()}function k(a){for(var b=0;b<e.lstAddress.length;b++){var c=e.lstAddress[b];if(c.Id==a){e.userData=c,e.getCitySelected(c.CityId),g(c.DistrictId);break}}$("#edit-address").openModal()}function l(){if(a.addressForm.$valid){if(!/^([()\- x+]*\d[()\- x+]*){4,16}$/.test(e.userData.PhoneNumber))return deliveryAlert(Message.Delivery_PhoneInfo),!1;e.userData.DistrictId=e.districtSelected.Id,e.userData.CityId=e.locationSelected.Id;if(e.userData.Id!=0){var c=e.userData.CreatedOn;e.userData.CreatedOn=new Date(parseInt(c.substr(6)))}E(e.userData.FullAddress),setTimeout(function(){e.userData.Id==0||e.userData.Id==null?b.createAddressInfo(e.userData).then(function(a){a.success?(m(),o(),e.userData=angular.copy(e.lstAddress[0]),deliveryAlert(Message.InsertSuccess)):deliveryAlert("Error.")}):b.updateAddressInfo(e.userData).then(function(a){a.success?(m(),o(),e.userData=angular.copy(e.lstAddress[0]),deliveryAlert(Message.UpdateSuccess)):deliveryAlert("Error.")})},1e3)}else deliveryAlert(Message.MissingInfo)}function m(){$("#edit-address").closeModal()}function n(a){deliveryConfirm({msg:ConfirmMessage.AreYouSureDelete,btnOK:Button.OK,btnCancel:Button.NoThanks},function(){b.deleteAddressInfo(a).then(function(a){a.success?(o(),e.userData=angular.copy(e.lstAddress[0])):deliveryAlert(Message.DeleteError)})})}function o(){b.getListAddressInfo().then(function(a){a.success&&(e.lstAddress=a.data)})}function p(){d.getUserPaymentSetting().then(function(a){if(a.success){if(a.data){var b=a.data.IsUserTokenExpired;if(b==1)$("#logout")[0].click();else{e.paymentSetting=a.data.PaymentSetting;if(e.paymentSetting!=null){var c=e.paymentSetting.PaidOptionSetting;for(var d=0;d<c.length;d++){var f=c[d].Id;f==4&&(e.CreditCardSetting.Default=c[d].Default=="No"?!1:!0,e.CreditCardSetting.Confirm=c[d].Confirm,e.CreditCardSetting.Confirm=="none"?e.confirmedCard=!1:(e.CreditCardSetting.Confirm="password",e.confirmedCard=!0))}}}}F()}})}function q(a){showPreloader(),setTimeout(function(){var b={Type:"deliverynow",PaidOption:{Id:1,Confirm:"none",Default:"Yes"}},c="";a===2?c="PayNow Credits":a===3?c="Bank Card":a===4?c="Credit Card":a===5?c="Napas":a===6?c="Toppay":a===7?c="Momo":a===12?c="Airpay Credit":c="Tiền mặt";if(a===4){if(e.paymentSetting==null)return hidePreloader(),deliveryAlert("Hiện tại bạn chưa có thẻ nào. Vui lòng thêm thẻ thanh toán!"),!1;b.PaidOption.Id=4;if(e.confirmedCard==1){if(e.CreditCardSetting.Confirm==null||e.CreditCardSetting.Confirm=="none"){e.CreditCardSetting.Confirm="password";var f=Message.DeN_Web_MemberConfirmCreditCardViaPassword;deliveryAlert(f)}b.PaidOption.Confirm=e.CreditCardSetting.Confirm}else b.PaidOption.Confirm="none",e.CreditCardSetting.Confirm="none"}else b.PaidOption.Id=a;d.updateUserPaymentSetting(b).then(function(b){if(b.success&&b.data){e.paymentSetting!=null&&(e.paymentSetting.Default=a);var d="";a===2&&e.isCheckedDeliveryNowAccountMethod==1?(c="Now Credits",d=format(Payment.PaymentDefaultAtDeliverynow,[c])):a===3&&e.isCheckedCyberSourceMethod==1?(c="Bank Card",d=format(Payment.PaymentDefaultAtDeliverynow,[c])):a===4&&e.isCheckedCreditMethod==1?c="Credit Card":a===6&&e.isCheckedToppayMethod==1?(c=Payment.Toppay,d=format(Payment.PaymentDefaultAtDeliverynow,[c])):a===7&&e.isCheckedMomoMethod==1?(c="Momo",d=format(Payment.PaymentDefaultAtDeliverynow,[c])):a===12&&e.isCheckedMomoMethod==1?(c="Airpay Credit",d=format(Payment.PaymentDefaultAtDeliverynow,[c])):a===1&&e.isCheckedCashOnDeliveryMethod==1&&(c=Payment.Cash,d=format(Payment.PaymentDefaultAtDeliverynow,[c])),d!=""&&deliveryAlert(d)}else deliveryAlert(Payment.NotChooseDefaultPayment);hidePreloader()})},1e3)}function r(){var a=!e.confirmedCard;a==1?(e.confirmedCard=!e.confirmedCard,$("#checkPasswordDialog").openModal({dismissible:!1})):u()}function s(){if(e.confirmPasswordText==="")return deliveryAlert(TopupMsg.ConfirmPasswordRequired),!1;t().then(function(a){if(a.success==0)return deliveryAlert(TopupMsg.WrongConfirmPassword),!1;e.confirmedCard=!e.confirmedCard,u(),e.confirmPasswordText="",$("#checkPasswordDialog").closeModal()})}function t(){var a=$.Deferred();return c.verifypassword(e.confirmPasswordText,e.paymentType.CyberSource).then(function(b){a.resolve(b)}),a.promise()}function u(){showPreloader(),setTimeout(function(){var a={Type:"deliverynow",PaidOption:{Id:4,Confirm:e.CreditCardSetting.Confirm,Default:"Yes"}};e.confirmedCard==0?(a.PaidOption.Confirm="none",e.CreditCardSetting.Confirm="none"):(a.PaidOption.Confirm="password",e.CreditCardSetting.Confirm="password"),a.PaidOption.Default=e.paymentSetting.Default==4?"Yes":"No",d.updateUserPaymentSetting(a).then(function(a){if(a.success){var b="";e.CreditCardSetting.Confirm==="sms"?b="Khi thực hiện giao dịch thanh toán đơn hàng. DeliveryNow sẽ xác thực giao dịch qua SMS và chi phí này sẽ được cộng vào tổng giá trị đơn hàng của quý khách!":e.CreditCardSetting.Confirm==="password"&&(b="Quý khách chọn xác thực credit card qua Password: DeliveryNow sẽ yêu cầu bạn nhập lại password trước khi hoàn tất giao dịch thanh toán đơn hàng."),b!=""&&deliveryAlert(b)}hidePreloader()})},1e3)}function v(a){location.href=a}function w(){c.getListDeliveryInvoiceInfo(e.invoicePageIndex,e.invoicePageSize).then(function(a){a.success&&a.data!=null&&(e.lstDeliveryInvoiceInfo=a.data)})}function x(){y()&&(e.deliveryInvoiceInfoId==0?c.addDeliveryInvoiceInfo(e.companyName,e.companyAddress,e.companyTaxCode).then(function(a){a.success?(w(),D(),deliveryAlert(Message.InsertSuccess)):deliveryAlert(Message.DeN_Web_Member_NotSaveInfoVat)}):B())}function y(){return e.companyName==null||e.companyName==""?(deliveryAlert(Message.InputCompanyName),!1):e.companyAddress==null||e.companyAddress==""?(deliveryAlert(Message.InputCompanyAddress),!1):e.companyTaxCode==null||e.companyTaxCode==""?(deliveryAlert(Message.RequiredInputTaxcode),!1):e.companyTaxCode.length<10&&angular.isNumber(e.companyTaxCode)==0?(deliveryAlert(Message.MessageValidTaxcode),!1):!0}function z(a,b,c,d){e.deliveryInvoiceInfoId=a,e.companyName=b,e.companyAddress=c,e.companyTaxCode=d}function A(){$("#update-delivery-invoice").closeModal()}function B(){c.updateDeliveryInvoiceInfo(e.deliveryInvoiceInfoId,e.companyName,e.companyAddress,e.companyTaxCode).then(function(a){a.success?(w(),D(),A(),deliveryAlert(Message.DeN_Web_UpdateSuccess)):deliveryAlert(Message.DeN_Web_SystemErrorPleaseTryAgain)})}function C(a){deliveryConfirm({msg:Message.DeN_Web_Member_AreYouWantDeleteVat,btnOK:Button.OK,btnCancel:Button.NoThanks},function(){c.deleteDeliveryInvoiceInfo(a).then(function(a){a.success?(w(),deliveryAlert(Message.DeleteSuccess)):deliveryAlert(Message.DeN_Web_Member_NotDeletePleaseTryAgain)})},function(){})}function D(){e.companyName="",e.companyAddress="",e.companyTaxCode="",e.deliveryInvoiceInfoId=0}function E(a){var b=new google.maps.Geocoder;b.geocode({address:a},function(a,b){if(b==google.maps.GeocoderStatus.OK){var c=a[0].geometry.location;e.userData.Latitude=c.lat(),e.userData.Longitude=c.lng(),e.userData.GoogleAddress=a[0].formatted_address}})}function F(){c.getPaymentMethods(e.IsFoodyDelivery).then(function(a){if(a.success){e.listPaymentMethod=a.data;for(var b=0;b<e.listPaymentMethod.length;b++)switch(e.listPaymentMethod[b].Id){case 1:e.listPaymentMethod[b].ShortLink="#cash",e.listPaymentMethod[b].ImageIcon="/Content/images/icons/icon-cash.png";break;case 2:e.listPaymentMethod[b].ShortLink="#acc-deli",e.listPaymentMethod[b].ImageIcon="/Content/images/icons/icon-paynow.png";break;case 4:e.listPaymentMethod[b].ShortLink="#credit-card",e.listPaymentMethod[b].ImageIcon="/Content/images/icons/icon-credit-card.png";break;case 8:e.listPaymentMethod[b].ShortLink="#credit-card",e.listPaymentMethod[b].ImageIcon="/Content/images/icons/icon-credit-card.png";break;case 6:e.listPaymentMethod[b].ShortLink="#e-wallet-toppay",e.listPaymentMethod[b].ImageIcon="/Content/images/icons/toppay.png";break;case 8:e.listPaymentMethod[b].ShortLink="#bank-card",e.listPaymentMethod[b].ImageIcon="/Content/images/icons/icon-bank-card.png";break;case 12:e.listPaymentMethod[b].ShortLink="#airpay-credit-card",e.listPaymentMethod[b].ImageIcon="/Content/images/icons/icon-credit-card.png"}}})}var e=this;e.district=[],e.location=[],e.locationSelected=null,e.districtSelected=null,e.lstAddress=[],e.paymentType={CashOnDelivery:1,DeliveryNowAccount:2,Bank:3,CyberSource:4,Napas:5,Toppay:6,Momo:7},e.paymentSetting={},e.userData=angular.copy(e.lstAddress[0]),e.userPromoCode="",e.confirmedCard=!1,e.addressLatLng={Latitude:0,Longitude:0,GoogleAddress:""},e.IsFoodyDelivery=!0,e.listPaymentMethod=[],e.isCheckedCreditMethod=!1,e.isCheckedDeliveryNowAccountMethod=!1,e.isCheckedCyberSourceMethod=!1,e.isCheckedToppayMethod=!1,e.isCheckedMomoMethod=!1,e.isCheckedCashOnDeliveryMethod=!1,e.confirmPasswordText="",e.deliveryInvoiceInfoId=0,e.companyName="",e.companyAddress="",e.companyTaxCode="",e.lstDeliveryInvoiceInfo=[],e.deliveryInvoiceInfoSelected={},e.invoicePageIndex=0,e.invoicePageSize=20,e.deliveryInvoiceCheckValue=!1,e.getListDeliveryInvoiceInfo=w,e.addDeliveryInvoiceInfo=x,e.CreditCardSetting={IsCreditCardDefault:!1,Default:!1,Confirm:"none"},e.add=j,e.close=m,e.edit=k,e.deleteFunc=n,e.getDistrictSelected=h,e.save=l,e.getCitySelected=i,e.aLocationSelected=g,e.getUserPaymentSetting=p,e.openChangePasswordUser=v,e.updateUserPaymentSetting=q,e.updateConfirmCardVia=u,e.updateDeliveryInvoiceInfo=B,e.deleteDeliveryInvoiceInfo=C,e.openEditDeliveryInvoiceInfo=z,e.closeEditDeliveryInvoiceInfo=A,e.openConfirmPasswordModal=r,e.checkConfirmPassword=s,a.$on("LastRepeaterElement",function(){setTimeout(function(){e.paymentSetting.Default!=1&&($("#paymentId1").removeClass("active").css("color","#a1a1a1"),$(".fa-angle-right").first().css("color","#a1a1a1"),$("#paymentId"+e.paymentSetting.Default).click())},100)}),f()}"use strict",angular.module("deliveryNow").controller("MemberController",a).directive("emitLastRepeaterElement",function(){return function(a){a.$last&&a.$emit("LastRepeaterElement")}}),a.$inject=["$scope","addressService","deliveryService","commonService"]})()
;(function(){function a(a,b){var c=[];for(var d=0;d<a.length;d++)c.push(a[d][b]);return c.join(", ")}"use strict",angular.module("deliveryNow").filter("joinObj",a)})()
